# 変更が反映されない時の対処マニュアル

このプロジェクトでは、以下の3つが原因で「何も変わっていない」ように見えることが多い。

- ブラウザキャッシュ（JS/CSSの古いチャンク）
- tldraw の永続データ（`persistenceKey` によるローカル保存）
- Docker 上の実行対象違い（想定外のコンテナ/ログを見ている）

## 0. 最初に確認すること

- URL が想定ホストか（Tailscale URL / localhost の取り違えがないか）
- `docker compose ps` で `nextjs-web` が `Up` か
- 見ているボードが想定 `boardId` か

## 1. 反映確認の基本手順（毎回これを実施）

1. ブラウザをハードリロードする（`Ctrl + Shift + R`）
2. 変化確認は「既存オブジェクト」ではなく「新規作成オブジェクト」で行う
3. それでも変わらない場合、`nextjs` サービスを再起動する

推奨コマンド:

```bash
docker compose restart nextjs
```

## 2. tldraw 固有ルール（重要）

`Tldraw` は `persistenceKey` でローカル保存されるため、過去データには新しい `meta` や shape props が入っていない場合がある。

- 既存シェイプに新機能が出ないのは正常なことがある
- 必ず新規ドロップ/新規作成で確認する

### 例

- 作成者ラベル: 旧データに `meta.createdBy` がないと表示差が出る
- 接続矢印: 旧操作で作られた矢印は、新ロジック適用前の状態を保持する場合がある

## 3. Docker 実行時の注意

この構成は bind mount を使うため、イメージ再ビルドだけでは問題が解決しないケースがある。

- コード差分反映: まず `restart`
- 依存や環境差分反映: `up --build`

```bash
docker compose up --build -d nextjs
```

## 4. 切り分けルール（必須）

「変わらない」と感じたら、次を順に確認する:

1. **コード差分があるか**: 該当ファイルに意図した変更があるか
2. **ランタイム差分があるか**: `docker compose logs nextjs` に再コンパイルログが出ているか
3. **データ差分があるか**: 新規作成データで再現するか
4. **UI差分があるか**: 表示対象がその機能の適用範囲内か

## 5. このプロジェクトの機能適用範囲ルール

作成者ラベルは現在、カスタム shape（`file-icon` / `text-file` / `audio-player`）で表示する。

- 画像/動画の native shape は同じ見た目仕様ではない
- 期待動作を確認するときは、対象 shape 種別を合わせること

## 6. 作業完了時チェックリスト

- [ ] ハードリロード後に確認した
- [ ] 新規オブジェクトで確認した
- [ ] 期待機能の適用対象 shape で確認した
- [ ] `docker compose ps` / `logs` で実行対象を確認した
- [ ] 再現手順を 3 行で記録した（次回用）

